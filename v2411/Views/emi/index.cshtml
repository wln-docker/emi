@{ Layout = "../_all.cshtml";}
@section head{
    <script>var sslCertTrusted = ('@Html.Raw(ViewBag.CheckCA)' == 'true' ? false : true)</script>
    <script src="https://ca.wlniao.cn/ssltest.js" async></script>
    <style type="text/css">
        #app {display:flex;width:100vw;height:100vh;flex-flow:row nowrap;justify-content:space-between; }
        #left {user-select:none;width:168px;background:#1f2126;overflow:hidden;}
        #left .logo {width:168px;height:60px;min-height:60px;line-height:60px;overflow:hidden;font-size:0px;text-align:center;background:#25282d center center no-repeat;background-size:90% }
        #mobile {width:100%;height:100%;padding:1vw;background-color:#f1f1f1;padding-bottom:20vw;overflow-y: auto;}

        .mapp-group {
            margin: 1vw;
            padding: 3vw 4vw;
            font-size: 3.6vw;
            color: #9c9c9c;
            background: #ffffff;
            border-radius: 2vw;
        }

        .mapp-title {
            margin-bottom: 5vw;
		}

		.mapp-boxs {
			display: flex;
			flex-wrap: wrap;
		}

        .mapp-item {
            flex: 0 0 25%;
            height: 24vw;
            display: inline-flex;
            text-align: center;
            align-items: center;
            justify-items: center;
            flex-direction: column;
        }

        .mapp-icon-box {
            padding: 1.5vw;
            border-radius: 2vw;
            background: #3c9bff;
            background-size: 60%;
            background-repeat: no-repeat;
            background-position: center;
        }

        .mapp-icon-svg {
            width: 8vw;
            height: 8vw;
            display: block;
            background: #ffffff;
            -webkit-mask: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAANSURBVBhXY2BgYGAAAAAFAAGKM+MAAAAAAElFTkSuQmCC) no-repeat 50% 50% /8vw;
        }

        .mapp-name {
            height: 6vw;
            color: #111111;
            margin: 1vw 2vw 0 2vw;
        }
        .mapp-sublist-mask{
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            position: absolute;
            background-color: #9c9c9c9c;
		}

		.mapp-sublist-boxs {
            margin: 20vw 15vw;
            background: #ffffff;
            border-radius: 3vw;
            text-align: center;
        }

        .mapp-sublist-tips {
            color: #9c9c9c;
            font-size: 4vw;
            line-height: 10vw;
            border-bottom: 5px solid #f9f9f9;
        }
        .mapp-sublist-list {
            min-height: 30vh;
            max-height: 50vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .mapp-sublist-item {
            font-size: 4vw;
            line-height: 12vw;
            color: #3a8ee6;
        }
        .mapp-sublist-item:not(:first-child) {
            border-top: 3px solid #f9f9f9;
        }



        #center {flex-grow:1;background:#f9f9f9;position:relative;overflow:hidden }
        .menu {height:100%;overflow-y:auto;overflow-x:hidden;}
        .menu::after {content:' ';height:70px;display:block;}
        .menu::-webkit-scrollbar {width:3px;}
        .menu::-webkit-scrollbar-track {background-color:#F5F5F5;}
        .menu::-webkit-scrollbar-thumb {background-color:#ff4949;}
        .menu-title {font-size:12px;color:#585858;padding:12px 10px 0 10px;font-weight:400;}
        .menu-item {color:#d0d0d0;display:block;margin:1px 0;padding:5px 0px 7px 18px;font-weight:100;cursor:pointer;}
        .menu-item > span {max-width:120px;display:inline-block;vertical-align:middle}
        .menu-item.has-sub {padding-left:0px;}.menu-item.has-sub.is-active,.menu-item:hover {background-color:#465067bf;}
        .menu-item.active,.menu-item.menu-item-sub.active {color:#7effff;}
        .menu-item.router-link-exact-active {background:rgba(89,95,105,0.3);}
        .menu-icon {background:#9ba3af;width:18px;height:18px;display:inline-block;vertical-align:middle;-webkit-mask:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAANSURBVBhXY2BgYGAAAAAFAAGKM+MAAAAAAElFTkSuQmCC") no-repeat 50% 50% /18px;}.active .menu-icon {background-color:#7effff !important}
        .menu-switch {height:20px;width:100%;display:block;text-align:center;background:#2b2e38;cursor:pointer;}
        .menu-switch > img {transform:rotate(90deg);width:20px}
        .min #left,.min #left .logo {width:54px}
        .min #left .logo {background-image:url('/oem/logo-min.png')}
        .min #left .menu-switch > img {transform:rotate(0deg);}
        .min #left .menu-group {padding-top:0;}
        .min #left .menu-group:first-child {border-top:none;}
        .min #left .menu-title,.min #left .menu-item > span {display:none}
        .el-tabs__header {user-select:none;}
        .el-tabs__content {top:40px;left:0;right:0;bottom:0;padding:0 !important;position:absolute;}
        .el-tabs--border-card > .el-tabs__header .el-tabs__item.is-active {height:39px;}
        .el-tabs__nav-next,.el-tabs__nav-prev{line-height:39px;font-size:16px;}.el-tabs__nav-next:hover,.el-tabs__nav-prev:hover{background-color: #e2e2e2;color:#000000}.el-tabs__nav-wrap{margin-right:210px;}
        #tab-home .el-icon-close {display:none}
        .usertab {user-select:none;right:0;position:absolute;margin-top:1px;height:38px;line-height:38px;overflow:hidden;vertical-align:middle;padding-left:8px;color:#4f5f6f;z-index:1;box-sizing:border-box;background:#F5F7FA;border:none;}
        .ucenter-name {color:#4f5f6f;float:right;margin-right:15px;text-decoration:none;cursor:pointer;}
        .ucenter-icon {width:16px;height:16px;vertical-align:-3px;fill:currentColor;overflow:hidden;}
        #left .logo {background-image:url('@ViewBag.LogoBar')}
        .min #left .logo {background-image:url('@ViewBag.LogoMin')}
    </style>
}
@section body{
    <div id="app" :class="{ min: menu === 'min' }">
        <div id="left" v-if="!mobile" onselectstart="return false;">
            <div class="logo"></div>
            <div class="menu" id="menu">
                <span class="menu-switch" v-on:click="toggle"><img class="layout-menu-icon" src="/svg/menu-lines.svg" /></span>
                <div class="menu-group" v-for="gitem in groups">
                    <h2 class="menu-title" v-if="groups.length > 1">{{gitem.title}}</h2>
                    <div v-for="item in gitem.items">
                        <div v-if="item.sublist && item.sublist.length > 0">
                            <a :class="{'menu-item': true, 'has-sub': true, 'is-active':active == gitem.title + item.name}" v-on:click="submenu(gitem.title, item.name)">
                                <el-tooltip content="展开/收拢" placement="right">
                                    <i class="el-icon-arrow-down" v-if="active == gitem.title + item.name"></i><i class="el-icon-arrow-right" v-else></i>
                                </el-tooltip>
                                <el-tooltip :disabled="menu != 'min'" :content="item.name" placement="right"><em class="menu-icon" :style="{'mask-image':'url('+item.icon+')'}"></em></el-tooltip>
                                <span class="text">{{item.name}}</span>
                            </a>
                            <div class="menu-item-container" v-if="active == gitem.title + item.name">
                                <a :class="{'menu-item': true, 'menu-item-sub': true, 'active':active == gitem.title + item.name && tab == sub.name}" v-on:click="openTab(sub.name, sub.action)" v-for="sub in item.sublist">
                                    <el-tooltip :disabled="menu != 'min'" :content="sub.name" placement="right"><em class="menu-icon" :style="{'mask-image':'url('+ (sub.icon=='none' && menu === 'min'? '/svg/app.svg': sub.icon)+')'}"></em></el-tooltip>
                                    <span class="text">{{sub.name}}</span>
                                </a>
                            </div>
                        </div>
                        <a :class="{'menu-item': true, 'active':tab == item.name}" v-on:click="openTab(item.name, item.action)" v-else>
                            <el-tooltip :disabled="menu != 'min'" :content="item.name" placement="right"><em class="menu-icon" :style="{'mask-image':'url('+item.icon+')'}"></em></el-tooltip>
                            <span class="text">{{item.name}}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div id="mobile" v-if="mobile" v-on:click="closeSub">
            <el-empty v-if="loaded && groups.length == 0" description="移动工作台暂无已开通业务，请通过PC访问或联系管理员授权。"></el-empty>
            <div class="mapp-group" v-for="gitem in groups" v-else>
                <div class="mapp-title" v-if="gitem.title">{{gitem.title}}</div>
                <div class="mapp-boxs">
                    <div class="mapp-item" v-on:click.stop="openApp(item)" v-for="item in gitem.items">
                        <div>
                            <div class="mapp-icon-box"><em class="mapp-icon-svg" :style="{'mask-image':'url('+item.icon+')'}"></em></div>
                        </div>
                        <div class="mapp-name">{{item.name}}</div>
                    </div>
                </div>
            </div>
            <div class="mapp-sublist-mask" v-if="sublist.length > 0">
                <div class="mapp-sublist-boxs">
                    <div class="mapp-sublist-tips">请选择要执行的操作</div>
                    <div class="mapp-sublist-list">
                        <div class="mapp-sublist-item" v-on:click="openApp(item)" v-for="item in sublist">{{item.name}}</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="center" v-else>
            <div class="wlogo" style="user-select:none" onselectstart="return false">
                <div style="width:400px;height:75px;display:block;margin:auto;background:url('//static.wlniao.com/wlniao/console.png') center center no-repeat;background-size:100%;"></div>
                <p>HTTPS://WWW.WLNIAO.COM&nbsp;服务热线：023-88256732</p>
            </div>
            <div class="usertab">
                <span class="ucenter">
                    <span class="ucenter-name" v-on:click="openTab('', 'logout')"><i class="el-icon-switch-button" style="color:#586685;font-size:15px;vertical-align:-1px;font-weight:bolder"></i> <font>注销</font></span>
                    <span class="ucenter-name" v-on:click="openTab('个人档案', 'emi/profile')"><i class="el-icon-user-solid" style="color:#586685;font-size:15px;vertical-align:-1px"></i> <font>@Html.Raw(ViewBag.ShowName)</font></span>
                </span>
            </div>
            <el-tabs v-model="tab" type="border-card" closable v-on:tab-remove="closeTab" v-on:tab-click="clickTab">
                <el-tab-pane name="home">
                    <span slot="label" v-on:dblclick="clickAll()">
                        <i v-if="tabs.length == 0" class="el-icon-s-home"></i>
                        <el-tooltip v-else-if="tab == 'home'" content="双击可关闭全部窗口" placement="right-end"><i class="el-icon-s-home"></i></el-tooltip>
                        <el-tooltip v-else content="返回首页 双击可关闭全部窗口" placement="right-end"><i class="el-icon-s-home"></i></el-tooltip>
                    </span>
                    @if (!string.IsNullOrEmpty(ViewBag.EMain))
                    {
                        <iframe src="@Html.Raw(ViewBag.EMain)" frameborder="0" scrolling="auto" style="position:absolute;width:100%;height:100%;overflow:auto"></iframe>
                    }
                </el-tab-pane>
                <el-tab-pane v-for="item in tabs" :name="item.name" v-if="item.show > 0">
                    <span slot="label">{{item.name}}</span>
                    <iframe :src="item.link" loading="eager" scrolling="auto" frameborder="0" style="position:absolute;width:100%;height:100%;overflow:auto"></iframe>
                </el-tab-pane>
            </el-tabs>
            <div v-if="idmark" :style="{backgroundImage: idmark}" style="position:absolute;left:-20%;top:-60%;width:150%;height:200%;opacity:0.4;z-index:2147483647;user-select:none;pointer-events:none"></div>
        </div>
    </div>
}
@section foot{
    <script type="text/javascript">
        document.title = '@Html.Raw(ViewBag.SystemName)'
        var app = new Vue({
            el: '#app',
            data() {
                let tmp = typeof sessionStorage.session != 'undefined' ? JSON.parse(sessionStorage.session) : { tab: 'home', menu: '@Html.Raw(ViewBag.MinMenu)', active: '', tabs: [], groups: [] };
                tmp.mobile = document.documentElement.clientWidth < 820 && document.documentElement.clientHeight > 820
                tmp.sublist = []
                tmp.idmark = ''
                tmp.loaded = false
                return tmp
            },
            methods: {
                updateTab(action, name) {
                    name = name || this.tab
                    let t = this
                    let i = t.tabs.map(o => o.name).indexOf(name)
                    if (i < 0) {
                        i = t.tabs.map(o => o.name).indexOf(t.tab)
                    }
                    if (i >= 0) {
                        t.tabs[i].show = 0
                        t.tabs[i].link = action
                        setTimeout(function () {
                            t.tabs[i].show = new Date().getTime()
                            t.tab = name
                            t.save()
                        }, 20)
                    }
                },
                activeTab(name) {
                    let t = this
                    let i = t.tabs.map(o => o.name).indexOf(name)
                    if (i >= 0) {
                        t.tabs[i].show = new Date().getTime()
                        t.tab = name
                        t.save()
                    }
                },
                openTab(name, action) {
                    if (action == 'logout') {
                        Vue.prototype.$confirm('您正在注销登录, 是否继续?', '提示', {
                            confirmButtonText: '立即退出',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            location.href = '/logout'
                        }).catch(() => { });
                    } else if (name && action) {
                        let t = this
                        let i = t.tabs.map(o => o.name).indexOf(name)
                        if (i < 0) {
                            t.tabs.push({ name: name, link: action, show: new Date().getTime() })
                            t.tab = name
                            t.save()
                        } else {
                            t.tabs[i].show = 0
                            t.tabs[i].link = action
                            //t.tabs.splice(i, 1)
                            setTimeout(function () {
                                //t.tabs.splice(i, 0, { name: name, link: action, show: new Date().getTime() })
                                t.tabs[i].show = new Date().getTime()
                                t.tab = name
                                t.save()
                            }, 20)
                        }
                    }
                },
                openApp(item) {
                    if (!item.action || (item.sublist && item.sublist.length > 0)) {
                        this.sublist = item.sublist
                        console.log(this.sublist)
                    } else {
                        this.closeSub()
                        document.title = item.name
                        location.href = item.action
                    }
                },
                closeSub() {
                    this.sublist = []
                },
                closeTab(name) {
                    let t = this
                    let i = t.tabs.map(o => o.name).indexOf(name)
                    if (i >= 0) {
                        t.tabs[i].show = 0
                        let tmp = t.tabs.filter(o => o.show > 0)
                        if (tmp.length > 0) {
                            t.tab = tmp.sort((a, b) => { return a.show - b.show })[tmp.length - 1].name
                        } else {
                            t.tab = 'home'
                            t.tabs = []
                        }
                        t.save()
                    }
                },
                clickTab(e) {
                    let i = this.tabs.map(o => o.name).indexOf(e.name)
                    if (i >= 0) {
                        this.tabs[i].show = new Date().getTime()
                    }
                    this.tab = e.name
                    this.save()
                },
                clickAll() {
                    this.tab = 'home'
                    this.tabs = []
                    this.save()
                },
                submenu(group, item) {
                    if (this.active == (group + item)) {
                        this.active = ''
                    } else {
                        this.active = (group + item)
                        this.menu = ''
                    }
                    this.save()
                },
                toggle() {
                    if (this.menu == 'min') {
                        this.menu = ''
                        this.active = this.activeTmp||''
                    } else {
                        this.menu = 'min'
                        this.activeTmp = this.active
                        this.active = ''
                    }
                    this.save()
                },
                save() {
                    sessionStorage.setItem('session', JSON.stringify({ tab: this.tab, menu: this.menu, active: this.active, activeTmp: this.activeTmp, tabs: this.tabs, groups: this.groups }));
                    this.$forceUpdate()
                }
            },
            mounted() {
                if ('undefined' != typeof sessionStorage.menu) { this.groups = JSON.parse(sessionStorage.menu) }
                if ('true' == '@Html.Raw(ViewBag.ShowIDMark)') { asyncGet('/idmark').then(res => { if (res.success) { this.idmark = 'url(' + res.data + ')' } }) }
                asyncGet('/menu?mobile=' + this.mobile).then(res => { this.groups = res; this.loaded = true; this.save() })
            }
        });
        function activeTab(title) {
            app.activeTab(title)
        }
        function closeTab(title) {
            app.closeTab(title)
        }
        function openTab(url, title) {
            app.openTab(title || '新窗口', url)
        }
        function setTab(url, title) {
            app.updateTab(url, title)
        }
        try {
            window.addEventListener('message', (e) => {
                let iframes = document.getElementsByTagName("iframe")
                for (let i = 0; i < iframes.length; i++) {
                    try { iframes[i].contentWindow.postMessage(e.data, '*') } catch (e) { }
                }
            }, false)
            if (window.location.href.indexOf("https") < 0 && '@Html.Raw(ViewBag.ToHttps)' == 'true') {
                let url = window.location.href.replace("http:", "https:");
                window.location.replace(url);
            }
            if (!sslCertTrusted) {
                openTab('/emi/ca', '请先安装证书');
            }
        } catch (e) { }
    </script>
}

